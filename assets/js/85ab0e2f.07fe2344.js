"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[97],{3905:(e,t,o)=>{o.d(t,{Zo:()=>l,kt:()=>d});var n=o(7294);function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function i(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function r(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?i(Object(o),!0).forEach((function(t){a(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):i(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function s(e,t){if(null==e)return{};var o,n,a=function(e,t){if(null==e)return{};var o,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||(a[o]=e[o]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(a[o]=e[o])}return a}var p=n.createContext({}),c=function(e){var t=n.useContext(p),o=t;return e&&(o="function"==typeof e?e(t):r(r({},t),e)),o},l=function(e){var t=c(e.components);return n.createElement(p.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var o=e.components,a=e.mdxType,i=e.originalType,p=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),u=c(o),m=a,d=u["".concat(p,".").concat(m)]||u[m]||h[m]||i;return o?n.createElement(d,r(r({ref:t},l),{},{components:o})):n.createElement(d,r({ref:t},l))}));function d(e,t){var o=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=o.length,r=new Array(i);r[0]=m;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[u]="string"==typeof e?e:a,r[1]=s;for(var c=2;c<i;c++)r[c]=o[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,o)}m.displayName="MDXCreateElement"},7544:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>p,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var n=o(7462),a=(o(7294),o(3905));const i={title:"Deployment pipelines"},r=void 0,s={unversionedId:"part-3/section-2",id:"part-3/section-2",title:"Deployment pipelines",description:"CI/CD pipeline (sometimes called deployment pipeline) is a corner stone of DevOps.",source:"@site/docs/part-3/section-2.md",sourceDirName:"part-3",slug:"/part-3/section-2",permalink:"/part-3/section-2",draft:!1,editUrl:"https://github.com/docker-hy/docker-hy.github.io/blob/master/docs/part-3/section-2.md",tags:[],version:"current",frontMatter:{title:"Deployment pipelines"},sidebar:"materialSidebar",previous:{title:"Official Images and trust",permalink:"/part-3/section-1"},next:{title:"Using a non-root user",permalink:"/part-3/section-3"}},p={},c=[{value:"Exercises 3.1-3.4",id:"exercises-31-34",level:2}],l={toc:c},u="wrapper";function h(e){let{components:t,...i}=e;return(0,a.kt)(u,(0,n.Z)({},l,i,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/CI/CD"},"CI/CD")," pipeline (sometimes called deployment pipeline) is a corner stone of DevOps.\nAccording to ",(0,a.kt)("a",{parentName:"p",href:"https://about.gitlab.com/topics/ci-cd/"},"Gitlab"),":"),(0,a.kt)("p",null,"  ",(0,a.kt)("em",{parentName:"p"},"CI/CD automates much or all of the manual human intervention traditionally needed to get new code from a commit into production. With a CI/CD pipeline, development teams can make changes to code that are then automatically tested and pushed out for delivery and deployment. Get CI/CD right and downtime is minimized and code releases happen faster.")),(0,a.kt)("p",null,"Let us now see how one can set up a deployment pipeline that can be used to automatically deploy containerized software to ",(0,a.kt)("em",{parentName:"p"},"any")," machine. So every time you commit the code in your machine, the pipeline builds the image and starts it up in the server."),(0,a.kt)("p",null,"Since we cannot assume that everyone has access to their own server, we will demonstrate the pipeline using ",(0,a.kt)("em",{parentName:"p"},"a local machine")," as the development target, but the exactly same steps can be used for a virtual machine in the cloud (such as one provided by ",(0,a.kt)("a",{parentName:"p",href:"https://www.hetzner.com/cloud"},"Hetzner"),") or even Raspberry Pi."),(0,a.kt)("p",null,"We will use ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/features/actions"},"GitHub Actions")," to build an image and push the image to Docker Hub, and then use a project called ",(0,a.kt)("a",{parentName:"p",href:"https://containrrr.dev/watchtower/"},"Watchtower")," to automatically pull and restart the new image in the target machine."),(0,a.kt)("p",null,"As an example, we will look repository ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/docker-hy/docker-hy.github.io"},"https://github.com/docker-hy/docker-hy.github.io"),", that is, the material of this course."),(0,a.kt)("p",null,"As was said ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/features/actions"},"GitHub Actions")," is used to implement the first part of the deployment pipeline. The ",(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/learn-github-actions/understanding-github-actions"},"documentation")," gives the following overview:"),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"GitHub Actions is a continuous integration and continuous delivery (CI/CD) platform that allows you to automate your build, test, and deployment pipeline. You can create workflows that build and test commit and every pull request to your repository, or deploy merged pull requests to production.")),(0,a.kt)("p",null,"The ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/docker-hy/docker-hy.github.io"},"project")," defines a ",(0,a.kt)("em",{parentName:"p"},"workflow")," with GitHub Actions that builds a Docker image and pushes it to Docker Hub every time the code is pushed to the GitHub repository."),(0,a.kt)("p",null,"Let us now see how the workflow definition looks. It is stored in the file ",(0,a.kt)("em",{parentName:"p"},"deploy.yml")," inside the ",(0,a.kt)("em",{parentName:"p"},".github/workflows")," directory:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"name: Release DevOps with Docker # Name of the workflow\n\n# On a push to the branch named master\non:\n  push:\n    branches:\n      - master\n\n# Job called build runs-on ubuntu-latest\njobs:\n  deploy:\n    name: Deploy to GitHub Pages\n    # we are not interested in this job\n\n  publish-docker-hub:\n    name: Publish image to Docker Hub\n    runs-on: ubuntu-latest\n    steps:\n    # Checkout to the repository\n    - uses: actions/checkout@v2\n\n    # We need to login so we can later push the image without issues.\n    - name: Login to Docker Hub\n      uses: docker/login-action@v1\n      with:\n        username: ${{ secrets.DOCKERHUB_USERNAME }}\n        password: ${{ secrets.DOCKERHUB_TOKEN }}\n    # Builds devopsdockeruh/docker-hy.github.io\n    - name: Build and push\n      uses: docker/build-push-action@v2\n      with:\n        push: true\n        tags: devopsdockeruh/coursepage:latest\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/using-workflows"},"workflow")," has two  ",(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/using-jobs/using-jobs-in-a-workflow"},"jobs"),", we are now interested in the one that is called ",(0,a.kt)("em",{parentName:"p"},"publish-docker-hub"),". The other job, called ",(0,a.kt)("em",{parentName:"p"},"deploy")," takes care of deploying the page as a GitHub page."),(0,a.kt)("p",null,"A job consists of a series of ",(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idsteps"},"steps"),". Each step is a small operation or ",(0,a.kt)("em",{parentName:"p"},"action")," that does its part of the whole. The steps are the following"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/actions/checkout"},"actions/checkout@v2")," is used to check out the code from the repository"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/docker/login-action"},"docker/login-action@v1")," is used to log in to Docker Hub"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/docker/build-push-action"},"docker/build-push-action@v2")," is used to build the image and push it to Docker Hub")),(0,a.kt)("p",null,"The first action was one of the ready-made actions that GitHub provides. The latter two are official actions offered by Docker. See ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/marketplace/actions/build-and-push-docker-images"},"here")," for more info about the official Docker GitHub Actions."),(0,a.kt)("p",null,"Before the workflow will work, two ",(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/security-guides/encrypted-secrets"},"secrets")," should be added to the GitHub repository: ",(0,a.kt)("inlineCode",{parentName:"p"},"DOCKERHUB_TOKEN")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"DOCKERHUB_USERNAME"),". This is done by opening the repository in the browser and first pressing ",(0,a.kt)("em",{parentName:"p"},"Settings")," then ",(0,a.kt)("em",{parentName:"p"},"Secrets"),". The ",(0,a.kt)("inlineCode",{parentName:"p"},"DOCKERHUB_TOKEN")," can be created in Docker Hub from the  ",(0,a.kt)("em",{parentName:"p"},"Account Settings / Security"),"."),(0,a.kt)("p",null,'GitHub Actions are doing only the "first half" of the deployment pipeline: they are ensuring that every push to GitHub is built to a Docker image which is then pushed to Docker Hub.'),(0,a.kt)("p",null,"The other half of the deployment pipeline is implemented by a containerized service called ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/containrrr/watchtower"},"Watchtower")," which is an open-source project that automates the task of updating images. Watchtower will pull the source of the image (in this case Docker Hub) for changes in the containers that are running. The container that is running will be updated and automatically restarted when a new version of the image is pushed to Docker Hub. Watchtower respects tags e.g. q container using ubuntu:22.04 will not be updated unless a new version of ubuntu:22.04 is released."),(0,a.kt)("admonition",{title:"Security reminder: Docker Hub accessing your computer",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Note that now anyone with access to your Docker Hub also has access to your PC through this. If they push a malicious update to your application, Watchtower will happily download and start the updated version.")),(0,a.kt)("p",null,"Watchtower can be run eg. using the following Docker Compose file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3.8"\n\nservices:\n  watchtower:\n    image: containrrr/watchtower\n    environment:\n      -  WATCHTOWER_POLL_INTERVAL=60 # Poll every 60 seconds\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n    container_name: watchtower\n')),(0,a.kt)("p",null,"One needs to be careful when starting Watchtower with ",(0,a.kt)("em",{parentName:"p"},"docker compose up"),",  since it will try to update ",(0,a.kt)("strong",{parentName:"p"},"every")," image running the machine. The ",(0,a.kt)("a",{parentName:"p",href:"https://containrrr.github.io/watchtower/"},"documentation")," describes how this can be prevented."),(0,a.kt)("h2",{id:"exercises-31-34"},"Exercises 3.1-3.4"),(0,a.kt)("admonition",{title:"Exercise 3.1: Your pipeline",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"  Create now a similar deployment pipeline for a simple Node.js/Express app found\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/docker-hy/material-applications/tree/main/express-app"},"here"),"."),(0,a.kt)("p",{parentName:"admonition"},'  Either clone the project or copy the files to your own repository. Set up a similar deployment pipeline (or the "first half") using GitHub Actions that was just described. Ensure that a new image gets pushed to Docker Hub every time you push the code to GitHub (you may eg. change the message the app shows).'),(0,a.kt)("p",{parentName:"admonition"},"Note that there is an important change that you should make to the above workflow configuration, the branch should be named ",(0,a.kt)("em",{parentName:"p"},"main"),":"),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"name: Release Node.js app\n\non:\n  push:\n    branches:\n      - main\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      # ...\n")),(0,a.kt)("p",{parentName:"admonition"},"The earlier example still uses the old GitHub naming convention and calls the main branch ",(0,a.kt)("em",{parentName:"p"},"master"),"."),(0,a.kt)("p",{parentName:"admonition"},"Some of the actions that the above example uses are a bit outdated, so go through the documentation"),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/actions/checkout"},"actions/checkout")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/docker/login-action"},"docker/login-action")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/docker/"},"docker/build-push-action"))),(0,a.kt)("p",{parentName:"admonition"},"and use the most recent versions in your workflow."),(0,a.kt)("p",{parentName:"admonition"},"Keep an eye on the GitHub Actions page to see that your workflow is working:"),(0,a.kt)("p",{parentName:"admonition"},(0,a.kt)("img",{alt:"Github Actions page",src:o(3671).Z,width:"2158",height:"1352"})),(0,a.kt)("p",{parentName:"admonition"},"Ensure also from Docker Hub that your image gets pushed there."),(0,a.kt)("p",{parentName:"admonition"},"Next, run your image locally in detached mode, and ensure that you can access it with the browser."),(0,a.kt)("p",{parentName:"admonition"},"Now set up and run the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/containrrr/watchtower"},"Watchtower")," just as described above."),(0,a.kt)("p",{parentName:"admonition"},"You might do these two in a single step in a shared Docker Compose file."),(0,a.kt)("p",{parentName:"admonition"},"Now your deployment pipeline is set up! Ensure that it works:"),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"make a change to your code")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"commit and push the changes to GitHub")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"wait for some time (the time it takes for GitHub Action to build and push the image plus the Watchtower poll interval)")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"reload the browser to ensure that Watchtower has started the new version (that is, your changes are visible)"),(0,a.kt)("p",{parentName:"li"},"Submit a link to the repository with the config.")))),(0,a.kt)("admonition",{title:"Exercise 3.2: A deployment pipeline to a cloud service",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"  In ",(0,a.kt)("a",{parentName:"p",href:"/part-1/section-6#exercises-115-116"},"Exercise 1.16")," you deployed a containerized app to a cloud service."),(0,a.kt)("p",{parentName:"admonition"},"  Now it is time to improve your solution by setting up a deployment pipeline for it so that every push to GitHub results in a new deployment to the cloud service."),(0,a.kt)("p",{parentName:"admonition"},"  You will most likely find a ready-made GitHub Action that does most of the heavy lifting your you... Google is your friend!"),(0,a.kt)("p",{parentName:"admonition"},"  Submit a link to the repository with the config. The repository README should have a link to the deployed application.")),(0,a.kt)("admonition",{title:"Exercise 3.3: Scripting magic",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"  Create a now script/program that downloads a repository from GitHub, builds a Dockerfile located in the root and then publishes it into the Docker Hub."),(0,a.kt)("p",{parentName:"admonition"},"  You can use any scripting or programming language to implement the script. Using ",(0,a.kt)("a",{parentName:"p",href:"https://www.shellscript.sh/"},"shell script")," might make the next exercise a bit easier... and do not worry if you have not done a shell script earlier, you do not need much for this exercise and Google helps."),(0,a.kt)("p",{parentName:"admonition"},"  The script could eg. be designed to be used so that as the first argument it gets the GitHub repository and as the second argument the Docker Hub repository. Eg. when run as follows"),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"./builder.sh mluukkai/express_app mluukkai/testing\n")),(0,a.kt)("p",{parentName:"admonition"},"  the script clones ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/mluukkai/express_app"},"https://github.com/mluukkai/express_app"),", builds the image, and pushes it to Docker Hub repository mluukkai/testing")),(0,a.kt)("admonition",{title:"Exercise 3.4: Building images from inside of a container",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"As seen from the Docker Compose file, the Watchtower uses a volume to ",(0,a.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/35110146/can-anyone-explain-docker-sock"},"docker.sock")," socket to access the Docker daemon of the host from the container:"),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"services:\nwatchtower:\n  image: containrrr/watchtower\n  volumes:\n    - /var/run/docker.sock:/var/run/docker.sock\n  # ...\n")),(0,a.kt)("p",{parentName:"admonition"},'   In practice this means that Watchtower can run commands on Docker the same way we can "command" Docker from the cli with ',(0,a.kt)("em",{parentName:"p"},"docker ps"),", ",(0,a.kt)("em",{parentName:"p"},"docker run")," etc."),(0,a.kt)("p",{parentName:"admonition"},"  We can easily use the same trick in our own scripts! So if we mount the ",(0,a.kt)("em",{parentName:"p"},"docker.sock")," socket to a container, we can use the command ",(0,a.kt)("em",{parentName:"p"},"docker")," inside the container, just like we are using it in the host terminal!"),(0,a.kt)("p",{parentName:"admonition"},"Dockerize now the script you did for the previous exercise. You can use images from ",(0,a.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/docker"},"this repository")," to run Docker inside Docker!"),(0,a.kt)("p",{parentName:"admonition"},"Your Dockerized could be run like this (the command is divided into many lines for better readability, note that copy-pasting a multiline command does not work):"),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre"},"docker run -e DOCKER_USER=mluukkai \\\n  -e DOCKER_PWD=password_here \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  builder mluukkai/express_app mluukkai/testing\n")),(0,a.kt)("p",{parentName:"admonition"},"Note that now the Docker Hub credentials are defined as environment variables since the script needs to log in to Docker Hub for the push."),(0,a.kt)("p",{parentName:"admonition"},"Submit the Dockerfile and the final version of your script."),(0,a.kt)("p",{parentName:"admonition"},"  Hint: you quite likely need to use ",(0,a.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/builder/#entrypoint"},"ENTRYPOINT")," in this Exercise.\nSee ",(0,a.kt)("a",{parentName:"p",href:"/part-1/section-4"},"Part 1")," for more.")))}h.isMDXComponent=!0},3671:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/gha-1a47a29ab8329eece9c71501422d01df.png"}}]);