{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-2/2-docker-networking","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Connecting two services such as a server and its database in docker can be achieved with docker-compose networks. In addition to starting services listed in docker-compose.yml the tool automatically creates and joins both containers into a network with a DNS. Each container service is named after their container name and as such containers can reference each other simply with their names."}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 622px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/604ec/docker-networks.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 35.21739130434782%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7klEQVQoz31PC46FIBDz/jfxTv7/BkFRARV1Np3El2zWt00aYKZTpkHf96SUoizLmEmSUNd1NM8zoVfXNbVtS03TUFVVXFvXlYqioDRNeSaKIirLkrTWFMBsWRbK85yJ5jiONE0TfYMx5mOGM45j/hT1YBgGNoSxEILwttbyJvu+s8F938wH0MBASsn3ZwFszhvi4pz7EIaIDBEiIx7iIgFq6L3NsOGyLP48T38cxx+O4+illF4p5Ydh8FprfjvnXvXXdfkAzt9wnicT0fE7sG0b/YdACBFaa0NjzC+iprUO67oOoQG7rgullK/6hz+4CRFX2ShO2gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n          "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/a0b58/docker-networks.webp 230w","/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/bc10c/docker-networks.webp 460w","/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/5bf66/docker-networks.webp 622w"],"sizes":"(max-width: 622px) 100vw, 622px","type":"image/webp"},"children":[]},{"type":"text","value":"\n          "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/81c8e/docker-networks.png 230w","/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/08a84/docker-networks.png 460w","/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/604ec/docker-networks.png 622w"],"sizes":"(max-width: 622px) 100vw, 622px","type":"image/png"},"children":[]},{"type":"text","value":"\n          "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/604ec/docker-networks.png","alt":"docker networks","title":"docker networks","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n        "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here are two services in a single network: webapp and webapp-helper. The webapp-helper has a server, listening for requests in port 3000, that webapp wants to access. Because they were defined in the same docker-compose.yml file the access is trivial. Docker-compose has already taken care of creating a network and webapp can simply send a request to webapp-helper:3000, the internal DNS will translate that to the correct access and ports do not have to be published outside of the network."}]},{"type":"element","tagName":"text-box","properties":{"name":"Security reminder: Plan your infrastructure and keep to your plan","variant":"hint"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the next exercise, and in some later exercises, I will supply you with an illustration of the infrastructure. Do look at it and use it to write the configuration."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For example, in 2.4 we don't want to open ports to Redis to the outside world. Do not add a "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ports"}]},{"type":"text","value":" configuration under redis. The backend will be able to access the application within the docker network."}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 2.4"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Add redis to example backend."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Redis is used to speed up some operations. Backend uses a slow api to get information. You can test the slow api by\nrequesting "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/ping?redis=true"}]},{"type":"text","value":" with curl. The frontend program has a button to test this."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Configure a redis container to cache information for the backend. Use the documentation if needed when configuring:\n"},{"type":"element","tagName":"a","properties":{"href":"https://hub.docker.com/_/redis/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://hub.docker.com/_/redis/"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The backend "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/docker-hy/material-applications/tree/main/example-backend","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"README"}]},{"type":"text","value":" should have all the information needed to\nconnect."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When you've correctly configured the button will turn green."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Submit the docker-compose.yml"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 713px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/38b6cf283aab86defb981043fc6bc215/01267/back-front-and-redis.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 26.956521739130434%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABcklEQVQY0z2QP0jDQBTGn2hxUZwFEREEcXRydhJnwUW7ODnoIhQ76dBFN4eCQ6uLtlOhQ6fiULJIC/1DriU5kmublELPXC9HQ9Ol5OQK+uBbfrz3vu89SCQS2wCwomnaca1WixeLxT0pJbiuWxkMBrLb7UrHcSSlVFe8Wq2CYRg7ruueUkpPLMs6VlwI8cgYq0A+nz8AgNVcLrfV6XRu6vX6osEwjNter/eOMU4TQt4IIfdhGG5QSsG27evxeCw555IxJjOZzKZlWd/KHBBC+6lUar3RaJyZpnmJMb4qlUqHjuO8CCFsznk9CAJzOBx+lsvlS4TQQ6vVuqOUJj3Pi2OMz1UAhNBRu92+AF3XQQEp5YqUcjmKothoNAJKaZpz7jLGdCFE3/O8D03T1jDGzxjjpJrp9/tnQRB8+b7/OplMYrZtAzSbzaXZbAbz+RyiKFosLxQKfyb/UpXNZtW56h0L5vv+03Q6lWEY/hBCdjnn8AszgiCcnqqN7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n          "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/38b6cf283aab86defb981043fc6bc215/a0b58/back-front-and-redis.webp 230w","/static/38b6cf283aab86defb981043fc6bc215/bc10c/back-front-and-redis.webp 460w","/static/38b6cf283aab86defb981043fc6bc215/69b3e/back-front-and-redis.webp 713w"],"sizes":"(max-width: 713px) 100vw, 713px","type":"image/webp"},"children":[]},{"type":"text","value":"\n          "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/38b6cf283aab86defb981043fc6bc215/81c8e/back-front-and-redis.png 230w","/static/38b6cf283aab86defb981043fc6bc215/08a84/back-front-and-redis.png 460w","/static/38b6cf283aab86defb981043fc6bc215/01267/back-front-and-redis.png 713w"],"sizes":"(max-width: 713px) 100vw, 713px","type":"image/png"},"children":[]},{"type":"text","value":"\n          "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/38b6cf283aab86defb981043fc6bc215/01267/back-front-and-redis.png","alt":"back front and redis","title":"back front and redis","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n        "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The "},{"type":"element","tagName":"a","properties":{"href":"https://docs.docker.com/compose/compose-file/compose-file-v3/#restart","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"restart: unless-stopped"}]},{"type":"text","value":" configuration can help if the redis takes a while to get ready."}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You can also manually define the network and its name. A major benefit of defining network is that it makes it easy to setup a configuration where other containers connect to an existing network as an external network. This is used when a container wishes to interact with a container defined in another docker-compose file."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Defining network in docker-compose.yml. Services can be added to networks by adding "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"networks"}]},{"type":"text","value":" into the definition of the service:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"3.8\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"db"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" postgres"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"13.2"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alpine\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"networks"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" database"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"network "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Name in this docker-compose file"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"networks"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"database-network"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Name in this docker-compose file"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" database"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"network "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Name that will be the actual name of the network"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This defines a network called "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"database-network"}]},{"type":"text","value":" which is created with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":" and removed with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose down"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To connect to an external network (possibly defined another docker-compose.yml):"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"3.8\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"db"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" backend"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"image\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"networks"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" database"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"network\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"networks"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"database-network"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"external"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" database"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"network "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Must match the actual name of the network"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"By default all services are added to a network called "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"default"}]},{"type":"text","value":". The default network can be configured and this makes it possible to connect to an external network by default as well:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"3.8\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"db"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" backend"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"image\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"networks"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"default"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"external"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" database"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"network "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Must match the actual name of the network"}]}]}]}]},{"type":"element","tagName":"h1","properties":{"id":"scaling","style":"position:relative;"},"children":[{"type":"text","value":"Scaling"},{"type":"element","tagName":"a","properties":{"href":"#scaling","ariaLabel":"scaling permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Compose can also scale the service to run multiple instances:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker-compose up --scale whoami=3\n\n  WARNING: The \"whoami\" service specifies a port on the host. If multiple containers for this service are created on a single host, the port will clash.\n\n  Starting whoami_whoami_1 ... done\n  Creating whoami_whoami_2 ... error\n  Creating whoami_whoami_3 ... error"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The command fails due to a port clash, as each instance will attempt to bind to the same host port (8000)."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can get around this by only specifying the container port. As mentioned in "},{"type":"element","tagName":"a","properties":{"href":"/part1/#allowing-external-connections-into-containers"},"children":[{"type":"text","value":"part 1"}]},{"type":"text","value":", when leaving the host port unspecified, Docker will automatically choose a free port."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Update the ports definition in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose.yml"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"8000"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then run the command again:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker-compose up --scale whoami=3\n  Starting whoami_whoami_1 ... done\n  Creating whoami_whoami_2 ... done\n  Creating whoami_whoami_3 ... done"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"All three instances are now running and listening on random host ports. We can use "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose port"}]},{"type":"text","value":" to find out which ports the instances are bound to."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker-compose port --index 1 whoami 8000\n  0.0.0.0:32770\n\n$ docker-compose port --index 2 whoami 8000\n  0.0.0.0:32769\n\n$ docker-compose port --index 3 whoami 8000\n  0.0.0.0:32768"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can now curl from these ports:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ curl 0.0.0.0:32769\n  I'm 536e11304357\n\n$ curl 0.0.0.0:32768\n  I'm 1ae20cd990f7"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In a server environment you'd often have a load balancer in-front of the service. For local environment (or a single server) one good solution is to use "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/jwilder/nginx-proxy","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://github.com/jwilder/nginx-proxy"}]},{"type":"text","value":" that configures nginx from docker daemon as containers are started and stopped."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's add the proxy to our compose file and remove the port bindings from the whoami service. We'll mount our "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker.sock"}]},{"type":"text","value":" inside of the container in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":":ro"}]},{"type":"text","value":" read-only mode."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"3.8\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"whoami"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/whoami\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"proxy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"proxy\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" /var/run/docker.sock"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/tmp/docker.sock"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"ro\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","datetime","number"]},"children":[{"type":"text","value":"80:80"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When we start this and test"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker-compose up -d --scale whoami=3\n$ curl localhost:80\n  <html>\n  <head><title>503 Service Temporarily Unavailable</title></head>\n  <body bgcolor=\"white\">\n  <center><h1>503 Service Temporarily Unavailable</h1></center>\n  <hr><center>nginx/1.13.8</center>\n  </body>\n  </html>"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It's \"working\", but the nginx just doesn't know which service we want. The "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"nginx-proxy"}]},{"type":"text","value":" works with two environment variables: "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"VIRTUAL_HOST"}]},{"type":"text","value":" and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"VIRTUAL_PORT"}]},{"type":"text","value":". "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"VIRTUAL_PORT"}]},{"type":"text","value":" is not needed if the service has "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"EXPOSE"}]},{"type":"text","value":" in it's docker image. We can see that "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"jwilder/whoami"}]},{"type":"text","value":" sets it: "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/jwilder/whoami/blob/master/Dockerfile#L9","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://github.com/jwilder/whoami/blob/master/Dockerfile#L9"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Note:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"For Mac users with the M1 chip you may see the following error message: "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"runtime: failed to create new OS thread"}]},{"type":"text","value":". In this case you can use the docker image "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ninanung/nginx-proxy"}]},{"type":"text","value":" instead which offers a temporary fix until "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"jwilder/nginx-proxy"}]},{"type":"text","value":" is updated to support M1 Macs."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The domain "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"colasloth.com"}]},{"type":"text","value":" is configured so that all subdomains point to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"127.0.0.1"}]},{"type":"text","value":". More information about how this works can be found at "},{"type":"element","tagName":"a","properties":{"href":"https://colasloth.github.io","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"colasloth.github.io"}]},{"type":"text","value":", but in brief it's a simple DNS \"hack\". Several other domains serving the same purpose exist, such as "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"localtest.me"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"lvh.me"}]},{"type":"text","value":", and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"vcap.me"}]},{"type":"text","value":", to name a few. In any case, let's use "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"colasloth.com"}]},{"type":"text","value":" here:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"3.8\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"whoami"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/whoami\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"environment"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" VIRTUAL_HOST=whoami.colasloth.com\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"proxy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"proxy\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" /var/run/docker.sock"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/tmp/docker.sock"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"ro\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","datetime","number"]},"children":[{"type":"text","value":"80:80"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now the proxy works:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker-compose up -d --scale whoami=3\n$ curl whoami.colasloth.com\n  I'm f6f85f4848a8\n$ curl whoami.colasloth.com\n  I'm 740dc0de1954"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's add couple of more containers behind the same proxy. We can use the official "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" image to serve a simple static web page. We don't have to even build the container images, we can just mount the content to the image. Let's prepare some content for two services called \"hello\" and \"world\"."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ echo \"hello\" > hello.html\n$ echo \"world\" > world.html"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then add these services to the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose.yml"}]},{"type":"text","value":" file where you mount just the content as "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":" in the default nginx path:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"hello"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"1.19"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alpine\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" ./hello.html"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/usr/share/nginx/html/index.html"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"ro\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"environment"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" VIRTUAL_HOST=hello.colasloth.com\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"world"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"1.19"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alpine\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" ./world.html"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/usr/share/nginx/html/index.html"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"ro\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"environment"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" VIRTUAL_HOST=world.colasloth.com"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now let's test:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker-compose up -d --scale whoami=3\n$ curl hello.colasloth.com\n  hello\n\n$ curl world.colasloth.com\n  world\n\n$ curl whoami.colasloth.com\n  I'm f6f85f4848a8\n\n$ curl whoami.colasloth.com\n  I'm 740dc0de1954"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now we have a basic single machine hosting setup up and running."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Test updating the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"hello.html"}]},{"type":"text","value":" without restarting the container, does it work?"}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 2.5"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A project over at "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/docker-hy/material-applications/tree/main/scaling-exercise","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://github.com/docker-hy/material-applications/tree/main/scaling-exercise"}]},{"type":"text","value":" has a hardly working application. Go ahead and clone it for yourself. The project already includes docker-compose.yml so you can start it by running "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Application should be accessible through "},{"type":"element","tagName":"a","properties":{"href":"http://localhost:3000","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"http://localhost:3000"}]},{"type":"text","value":". However it doesn't work well enough and I've added a load balancer for scaling. Your task is to scale the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"compute"}]},{"type":"text","value":" containers so that the button in the application turns green."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This exercise was created with "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/sasumaki","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Sasu Mkinen"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Please return the used commands for this exercise."}]}]}]},"html":"<div><p>Connecting two services such as a server and its database in docker can be achieved with docker-compose networks. In addition to starting services listed in docker-compose.yml the tool automatically creates and joins both containers into a network with a DNS. Each container service is named after their container name and as such containers can reference each other simply with their names.</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 622px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/604ec/docker-networks.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 35.21739130434782%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7klEQVQoz31PC46FIBDz/jfxTv7/BkFRARV1Np3El2zWt00aYKZTpkHf96SUoizLmEmSUNd1NM8zoVfXNbVtS03TUFVVXFvXlYqioDRNeSaKIirLkrTWFMBsWRbK85yJ5jiONE0TfYMx5mOGM45j/hT1YBgGNoSxEILwttbyJvu+s8F938wH0MBASsn3ZwFszhvi4pz7EIaIDBEiIx7iIgFq6L3NsOGyLP48T38cxx+O4+illF4p5Ydh8FprfjvnXvXXdfkAzt9wnicT0fE7sG0b/YdACBFaa0NjzC+iprUO67oOoQG7rgullK/6hz+4CRFX2ShO2gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <picture>\n          <source srcset=\"/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/a0b58/docker-networks.webp 230w,\n/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/bc10c/docker-networks.webp 460w,\n/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/5bf66/docker-networks.webp 622w\" sizes=\"(max-width: 622px) 100vw, 622px\" type=\"image/webp\">\n          <source srcset=\"/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/81c8e/docker-networks.png 230w,\n/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/08a84/docker-networks.png 460w,\n/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/604ec/docker-networks.png 622w\" sizes=\"(max-width: 622px) 100vw, 622px\" type=\"image/png\">\n          <img class=\"gatsby-resp-image-image\" src=\"/static/b707bbcf3b2bd5dd7cf2c7d402cd85e1/604ec/docker-networks.png\" alt=\"docker networks\" title=\"docker networks\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n        </picture>\n  </a>\n    </span><p>Here are two services in a single network: webapp and webapp-helper. The webapp-helper has a server, listening for requests in port 3000, that webapp wants to access. Because they were defined in the same docker-compose.yml file the access is trivial. Docker-compose has already taken care of creating a network and webapp can simply send a request to webapp-helper:3000, the internal DNS will translate that to the correct access and ports do not have to be published outside of the network.</p><text-box name=\"Security reminder: Plan your infrastructure and keep to your plan\" variant=\"hint\"><p>In the next exercise, and in some later exercises, I will supply you with an illustration of the infrastructure. Do look at it and use it to write the configuration.</p><p>For example, in 2.4 we don't want to open ports to Redis to the outside world. Do not add a <code class=\"language-text\">ports</code> configuration under redis. The backend will be able to access the application within the docker network.</p></text-box><exercise name=\"Exercise 2.4\"><p>Add redis to example backend.</p><p>Redis is used to speed up some operations. Backend uses a slow api to get information. You can test the slow api by\nrequesting <code class=\"language-text\">/ping?redis=true</code> with curl. The frontend program has a button to test this.</p><p>Configure a redis container to cache information for the backend. Use the documentation if needed when configuring:\n<a href=\"https://hub.docker.com/_/redis/\" target=\"_blank\" rel=\"noopener noreferrer\">https://hub.docker.com/_/redis/</a></p><p>The backend <a href=\"https://github.com/docker-hy/material-applications/tree/main/example-backend\" target=\"_blank\" rel=\"noopener noreferrer\">README</a> should have all the information needed to\nconnect.</p><p>When you've correctly configured the button will turn green.</p><p>Submit the docker-compose.yml</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 713px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/38b6cf283aab86defb981043fc6bc215/01267/back-front-and-redis.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 26.956521739130434%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABcklEQVQY0z2QP0jDQBTGn2hxUZwFEREEcXRydhJnwUW7ODnoIhQ76dBFN4eCQ6uLtlOhQ6fiULJIC/1DriU5kmublELPXC9HQ9Ol5OQK+uBbfrz3vu89SCQS2wCwomnaca1WixeLxT0pJbiuWxkMBrLb7UrHcSSlVFe8Wq2CYRg7ruueUkpPLMs6VlwI8cgYq0A+nz8AgNVcLrfV6XRu6vX6osEwjNter/eOMU4TQt4IIfdhGG5QSsG27evxeCw555IxJjOZzKZlWd/KHBBC+6lUar3RaJyZpnmJMb4qlUqHjuO8CCFsznk9CAJzOBx+lsvlS4TQQ6vVuqOUJj3Pi2OMz1UAhNBRu92+AF3XQQEp5YqUcjmKothoNAJKaZpz7jLGdCFE3/O8D03T1jDGzxjjpJrp9/tnQRB8+b7/OplMYrZtAzSbzaXZbAbz+RyiKFosLxQKfyb/UpXNZtW56h0L5vv+03Q6lWEY/hBCdjnn8AszgiCcnqqN7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <picture>\n          <source srcset=\"/static/38b6cf283aab86defb981043fc6bc215/a0b58/back-front-and-redis.webp 230w,\n/static/38b6cf283aab86defb981043fc6bc215/bc10c/back-front-and-redis.webp 460w,\n/static/38b6cf283aab86defb981043fc6bc215/69b3e/back-front-and-redis.webp 713w\" sizes=\"(max-width: 713px) 100vw, 713px\" type=\"image/webp\">\n          <source srcset=\"/static/38b6cf283aab86defb981043fc6bc215/81c8e/back-front-and-redis.png 230w,\n/static/38b6cf283aab86defb981043fc6bc215/08a84/back-front-and-redis.png 460w,\n/static/38b6cf283aab86defb981043fc6bc215/01267/back-front-and-redis.png 713w\" sizes=\"(max-width: 713px) 100vw, 713px\" type=\"image/png\">\n          <img class=\"gatsby-resp-image-image\" src=\"/static/38b6cf283aab86defb981043fc6bc215/01267/back-front-and-redis.png\" alt=\"back front and redis\" title=\"back front and redis\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n        </picture>\n  </a>\n    </span><p>The <a href=\"https://docs.docker.com/compose/compose-file/compose-file-v3/#restart\" target=\"_blank\" rel=\"noopener noreferrer\">restart: unless-stopped</a> configuration can help if the redis takes a while to get ready.</p></exercise><p>You can also manually define the network and its name. A major benefit of defining network is that it makes it easy to setup a configuration where other containers connect to an existing network as an external network. This is used when a container wishes to interact with a container defined in another docker-compose file.</p><p>Defining network in docker-compose.yml. Services can be added to networks by adding <code class=\"language-text\">networks</code> into the definition of the service:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> postgres<span class=\"token punctuation\">:</span>13.2<span class=\"token punctuation\">-</span>alpine\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> database<span class=\"token punctuation\">-</span>network <span class=\"token comment\"># Name in this docker-compose file</span>\n\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">database-network</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># Name in this docker-compose file</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> database<span class=\"token punctuation\">-</span>network <span class=\"token comment\"># Name that will be the actual name of the network</span></code></pre></div><p>This defines a network called <code class=\"language-text\">database-network</code> which is created with <code class=\"language-text\">docker-compose up</code> and removed with <code class=\"language-text\">docker-compose down</code>.</p><p>To connect to an external network (possibly defined another docker-compose.yml):</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>image\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> database<span class=\"token punctuation\">-</span>network\n\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">database-network</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">external</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> database<span class=\"token punctuation\">-</span>network <span class=\"token comment\"># Must match the actual name of the network</span></code></pre></div><p>By default all services are added to a network called <code class=\"language-text\">default</code>. The default network can be configured and this makes it possible to connect to an external network by default as well:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>image\n\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">default</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">external</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> database<span class=\"token punctuation\">-</span>network <span class=\"token comment\"># Must match the actual name of the network</span></code></pre></div><h1 id=\"scaling\" style=\"position:relative;\">Scaling<a href=\"#scaling\" aria-label=\"scaling permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1><p>Compose can also scale the service to run multiple instances:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker-compose up --scale whoami=3\n\n  WARNING: The &quot;whoami&quot; service specifies a port on the host. If multiple containers for this service are created on a single host, the port will clash.\n\n  Starting whoami_whoami_1 ... done\n  Creating whoami_whoami_2 ... error\n  Creating whoami_whoami_3 ... error</code></pre></div><p>The command fails due to a port clash, as each instance will attempt to bind to the same host port (8000).</p><p>We can get around this by only specifying the container port. As mentioned in <a href=\"/part1/#allowing-external-connections-into-containers\">part 1</a>, when leaving the host port unspecified, Docker will automatically choose a free port.</p><p>Update the ports definition in <code class=\"language-text\">docker-compose.yml</code>:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token number\">8000</span></code></pre></div><p>Then run the command again:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker-compose up --scale whoami=3\n  Starting whoami_whoami_1 ... done\n  Creating whoami_whoami_2 ... done\n  Creating whoami_whoami_3 ... done</code></pre></div><p>All three instances are now running and listening on random host ports. We can use <code class=\"language-text\">docker-compose port</code> to find out which ports the instances are bound to.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker-compose port --index 1 whoami 8000\n  0.0.0.0:32770\n\n$ docker-compose port --index 2 whoami 8000\n  0.0.0.0:32769\n\n$ docker-compose port --index 3 whoami 8000\n  0.0.0.0:32768</code></pre></div><p>We can now curl from these ports:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ curl 0.0.0.0:32769\n  I&#39;m 536e11304357\n\n$ curl 0.0.0.0:32768\n  I&#39;m 1ae20cd990f7</code></pre></div><p>In a server environment you'd often have a load balancer in-front of the service. For local environment (or a single server) one good solution is to use <a href=\"https://github.com/jwilder/nginx-proxy\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/jwilder/nginx-proxy</a> that configures nginx from docker daemon as containers are started and stopped.</p><p>Let's add the proxy to our compose file and remove the port bindings from the whoami service. We'll mount our <code class=\"language-text\">docker.sock</code> inside of the container in <code class=\"language-text\">:ro</code> read-only mode.</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">whoami</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/whoami\n  <span class=\"token key atrule\">proxy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/nginx<span class=\"token punctuation\">-</span>proxy\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/tmp/docker.sock<span class=\"token punctuation\">:</span>ro\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token datetime number\">80:80</span></code></pre></div><p>When we start this and test</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker-compose up -d --scale whoami=3\n$ curl localhost:80\n  &lt;html&gt;\n  &lt;head&gt;&lt;title&gt;503 Service Temporarily Unavailable&lt;/title&gt;&lt;/head&gt;\n  &lt;body bgcolor=&quot;white&quot;&gt;\n  &lt;center&gt;&lt;h1&gt;503 Service Temporarily Unavailable&lt;/h1&gt;&lt;/center&gt;\n  &lt;hr&gt;&lt;center&gt;nginx/1.13.8&lt;/center&gt;\n  &lt;/body&gt;\n  &lt;/html&gt;</code></pre></div><p>It's \"working\", but the nginx just doesn't know which service we want. The <code class=\"language-text\">nginx-proxy</code> works with two environment variables: <code class=\"language-text\">VIRTUAL_HOST</code> and <code class=\"language-text\">VIRTUAL_PORT</code>. <code class=\"language-text\">VIRTUAL_PORT</code> is not needed if the service has <code class=\"language-text\">EXPOSE</code> in it's docker image. We can see that <code class=\"language-text\">jwilder/whoami</code> sets it: <a href=\"https://github.com/jwilder/whoami/blob/master/Dockerfile#L9\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/jwilder/whoami/blob/master/Dockerfile#L9</a></p><p>Note:</p><ul>\n<li>For Mac users with the M1 chip you may see the following error message: <code class=\"language-text\">runtime: failed to create new OS thread</code>. In this case you can use the docker image <code class=\"language-text\">ninanung/nginx-proxy</code> instead which offers a temporary fix until <code class=\"language-text\">jwilder/nginx-proxy</code> is updated to support M1 Macs.</li>\n</ul><p>The domain <code class=\"language-text\">colasloth.com</code> is configured so that all subdomains point to <code class=\"language-text\">127.0.0.1</code>. More information about how this works can be found at <a href=\"https://colasloth.github.io\" target=\"_blank\" rel=\"noopener noreferrer\">colasloth.github.io</a>, but in brief it's a simple DNS \"hack\". Several other domains serving the same purpose exist, such as <code class=\"language-text\">localtest.me</code>, <code class=\"language-text\">lvh.me</code>, and <code class=\"language-text\">vcap.me</code>, to name a few. In any case, let's use <code class=\"language-text\">colasloth.com</code> here:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">whoami</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/whoami\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> VIRTUAL_HOST=whoami.colasloth.com\n  <span class=\"token key atrule\">proxy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/nginx<span class=\"token punctuation\">-</span>proxy\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/tmp/docker.sock<span class=\"token punctuation\">:</span>ro\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token datetime number\">80:80</span></code></pre></div><p>Now the proxy works:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker-compose up -d --scale whoami=3\n$ curl whoami.colasloth.com\n  I&#39;m f6f85f4848a8\n$ curl whoami.colasloth.com\n  I&#39;m 740dc0de1954</code></pre></div><p>Let's add couple of more containers behind the same proxy. We can use the official <code class=\"language-text\">nginx</code> image to serve a simple static web page. We don't have to even build the container images, we can just mount the content to the image. Let's prepare some content for two services called \"hello\" and \"world\".</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ echo &quot;hello&quot; &gt; hello.html\n$ echo &quot;world&quot; &gt; world.html</code></pre></div><p>Then add these services to the <code class=\"language-text\">docker-compose.yml</code> file where you mount just the content as <code class=\"language-text\">index.html</code> in the default nginx path:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.19<span class=\"token punctuation\">-</span>alpine\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ./hello.html<span class=\"token punctuation\">:</span>/usr/share/nginx/html/index.html<span class=\"token punctuation\">:</span>ro\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> VIRTUAL_HOST=hello.colasloth.com\n<span class=\"token key atrule\">world</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.19<span class=\"token punctuation\">-</span>alpine\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ./world.html<span class=\"token punctuation\">:</span>/usr/share/nginx/html/index.html<span class=\"token punctuation\">:</span>ro\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> VIRTUAL_HOST=world.colasloth.com</code></pre></div><p>Now let's test:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker-compose up -d --scale whoami=3\n$ curl hello.colasloth.com\n  hello\n\n$ curl world.colasloth.com\n  world\n\n$ curl whoami.colasloth.com\n  I&#39;m f6f85f4848a8\n\n$ curl whoami.colasloth.com\n  I&#39;m 740dc0de1954</code></pre></div><p>Now we have a basic single machine hosting setup up and running.</p><p>Test updating the <code class=\"language-text\">hello.html</code> without restarting the container, does it work?</p><exercise name=\"Exercise 2.5\"><p>A project over at <a href=\"https://github.com/docker-hy/material-applications/tree/main/scaling-exercise\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/docker-hy/material-applications/tree/main/scaling-exercise</a> has a hardly working application. Go ahead and clone it for yourself. The project already includes docker-compose.yml so you can start it by running <code class=\"language-text\">docker-compose up</code>.</p><p>Application should be accessible through <a href=\"http://localhost:3000\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost:3000</a>. However it doesn't work well enough and I've added a load balancer for scaling. Your task is to scale the <code class=\"language-text\">compute</code> containers so that the button in the application turns green.</p><p>This exercise was created with <a href=\"https://github.com/sasumaki\" target=\"_blank\" rel=\"noopener noreferrer\">Sasu Mkinen</a></p><p>Please return the used commands for this exercise.</p></exercise></div>","frontmatter":{"path":"/part-2/2-docker-networking","title":"Docker networking"},"fileAbsolutePath":"/home/runner/work/docker-hy.github.io/docker-hy.github.io/data/part-2/section-2.md"},"allPages":{"edges":[{"node":{"id":"4352ae37-1cc5-5973-956b-aa3c8cc1a438","frontmatter":{"path":"/faq","title":"Frequently asked questions"}}},{"node":{"id":"e1238e90-e69f-5b89-ae7f-7a3890359b73","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"3cb91679-41d9-585e-8746-8d7f0fbc121a","frontmatter":{"path":"/getting-started","title":"Getting started"}}},{"node":{"id":"cc180895-565d-5264-95c9-d15f066c38c3","frontmatter":{"path":"/","title":"About this course"}}},{"node":{"id":"0601dd7a-78da-53bb-9402-15fadc681ddc","frontmatter":{"path":"/links","title":"Links"}}},{"node":{"id":"6c9405c1-39a6-56b2-934e-33850f881070","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"c5438964-0c78-52f9-b28f-f73711d88666","frontmatter":{"path":"/part-1/1-getting-started","title":"Definitions and basic concepts"}}},{"node":{"id":"a8076827-affa-555a-b777-dba87c8e257f","frontmatter":{"path":"/part-1/2-running-and-stopping","title":"Running and stopping containers"}}},{"node":{"id":"d1d17462-978a-5516-8207-0fff56d3d301","frontmatter":{"path":"/part-1/3-in-depth-dive-to-images","title":"In-depth dive to images"}}},{"node":{"id":"b86409c3-2663-57ce-9a34-5ba818f8c6f7","frontmatter":{"path":"/part-1/4-defining-start-conditions","title":"Defining start conditions for the container"}}},{"node":{"id":"f0602d39-4b70-5d33-81a1-44c74bc6a963","frontmatter":{"path":"/part-1/5-volumes-and-ports","title":"Interacting with the container via volumes and ports"}}},{"node":{"id":"eb754b3f-0629-5970-a322-6a4dc4564d67","frontmatter":{"path":"/part-1/6-docker-hub","title":"Utilizing tools from the Registry"}}},{"node":{"id":"d1c71e59-47d3-54fd-a486-383c8377fe36","frontmatter":{"path":"/part-1/7-summary","title":"Summary"}}},{"node":{"id":"0c108910-d460-5d9b-8099-772363806cd1","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"5ecd7aff-3a9d-5952-a0e4-50e15971e6be","frontmatter":{"path":"/part-2/1-migrating-to-docker-compose","title":"Migrating to docker compose"}}},{"node":{"id":"4007819b-0805-5da6-bf6a-99ded7c679ba","frontmatter":{"path":"/part-2/2-docker-networking","title":"Docker networking"}}},{"node":{"id":"663340ff-6dff-50cc-9bb2-25940e07ee07","frontmatter":{"path":"/part-2/3-volumes-in-action","title":"Volumes in action"}}},{"node":{"id":"fccc6c0d-db88-5605-9dcf-032a5afa0c28","frontmatter":{"path":"/part-2/4-containers-in-development","title":"Containers in development"}}},{"node":{"id":"d765d5bb-ef50-576a-8818-9938b2930e71","frontmatter":{"path":"/part-2/5-summary","title":"Summary"}}},{"node":{"id":"562b2219-bfee-5004-b19d-67666caa20c1","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"a43415c2-1067-541e-83ce-30fbd4938a64","frontmatter":{"path":"/part-3/1-deeper-understainding-of-containers","title":"Deeper understanding of containers"}}},{"node":{"id":"f13c2ceb-97e3-50e6-9153-9fd8c7b4eb5a","frontmatter":{"path":"/part-3/2-deployment-pipelines","title":"Deployment pipelines"}}},{"node":{"id":"baa5a147-830d-5a73-b883-2eef8b123a54","frontmatter":{"path":"/part-3/3-using-non-root-user","title":"Using a non-root user"}}},{"node":{"id":"b172f390-4ffa-568d-99e8-737985f35a70","frontmatter":{"path":"/part-3/4-optimizing-the-image-size","title":"Optimizing the image size"}}},{"node":{"id":"76657527-40ce-5179-88b3-0df3d0ae2ab9","frontmatter":{"path":"/part-3/5-multi-host-environments","title":"Multi-host environments"}}},{"node":{"id":"3405a024-ea45-5fd0-8004-ec8726591ee1","frontmatter":{"path":"/part-3/6-end","title":"End"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}